{% extends 'layouts/base.html' %} {% load static %} {% load crispy_forms_tags %}
{% block title %}Allocations {% endblock title%}

<!-- Specific CSS goes HERE -->
{% block stylesheets %}{% endblock stylesheets %} {% block content %}
<div class="container-fluid py-4" id="app">
  <div class="row">
    <div class="col-12">
      <div class="card mb-4">
        <div class="card-body px-0 pt-0 pb-2">
          <div class="container container-fluid">
            {% comment %} This is a tab for the allocation summary
            {%endcomment%}

            <div class="tab-content" id="myTabContent" style="height: 80vh">
                {% for program in programs %}
                <div class="tab-pane fade {% if forloop.first %}show{% endif %}" id="tab{{ program.id }}"
                  role="tabpanel" aria-labelledby="tab{{ program.id }}-tab">
                  <h3>{{program.name}}</h3>
                  <div class="table-responsive p-0" style="height: 60vh">
                    <div class="table-responsive p-0" style="height: 65vh" id="allocation-table">
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
              <ul class="nav nav-tabs" id="myTab" role="tablist">
                {% for program in programs %}
                <li class="" role="presentation">
                  <a class="tab-link {% if forloop.first %}active{% endif %}" id="tab{{ program.id }}"
                    data-bs-toggle="tab" data-bs-target="#tab{{ program.id }}" type="button" role="tab"
                    aria-controls="home" aria-selected="true">
                    {{program.code}}
                  </a>
                </li>
                {% endfor %}
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endblock content %}

    <!-- Specific JS goes HERE -->
    {% block javascripts %}
    <script>
      const app = Vue.createApp({
        mounted() {

        

          fetch(`${this.url}`).then(res => res.json()).then(data =>{
            this.allocations = data

            var customMutator = function(value, data, type, params, component){
                  return `<td>${value}</td>\n`
            }
                
            var table = new Tabulator("#allocation-table", {
                data:this.allocations,
                autoColumns:true,
                formatter: customFormatter,
                columns:[
                  {title:"lecturer", field:"lecturer", formatter:"textarea"},
                  {title:"courses",field:"courses", formatter:customFormatter, mutator:customMutator,},
                ],
            });

            
            function customFormatter(cell, formatterParams, onRendered) {
              const val = cell.getValue();
              const cellDiv = document.createElement('div');
              for (let i = 0; i < val.length; i++){
                const valItemDiv = document.createElement('div');
                valItemDiv.textContent = val[i];
                valItemDiv.style.border = 'purple 1px solid';
                cellDiv.appendChild(valItemDiv);
              }
              return cellDiv;
            }
          })
        },
        data() {
          return {
            id: "",
            url: "http://localhost:8000/api/allocations",
            allocations : []
          };
        },
        delimiters: ["[[", "]]"],
        methods: {
          greet() {
            console.log("Hello");
          },
        },
      }).mount("#app");
    </script>
    {% endblock javascripts %}
  </div>