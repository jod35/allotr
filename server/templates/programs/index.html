{% extends 'layouts/base.html' %} {% load static %} {% load crispy_forms_tags %}
{% block title %} Programs {% endblock title %}

<!-- Specific CSS goes HERE -->
{% block stylesheets %}{% endblock stylesheets %} {% block content %}

<div class="container-fluid py-4" id="app">
  <div class="row">
    <div class="col-12">
      <div class="card mb-4">
        <div class="card-header pb-0">
          <h6>Programs</h6>
        </div>
        <div class="card-header pb-0">
          <button
            type="button"
            class="btn btn-sm bg-gradient-dark"
            data-bs-toggle="modal"
            data-bs-target="#ProgramCreateModal"
          >
            Add Program
          </button>
        </div>

        <div class="card-body px-0 pt-0 pb-2">
          <div class="table-responsive p-0">
            <table class="table align-items-center mb-0">
              <thead>
                <tr>
                  <th
                    class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7"
                  >
                    Program Name
                  </th>
                  <th
                    class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7"
                  >
                    Department
                  </th>
                  <th
                    class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7"
                  >
                    Degree Level
                  </th>
                </tr>
              </thead>
              <tbody>
                {% for program in programs %}
                <tr>
                  <td>
                    <div class="d-flex px-2 py-1">
                      <div>
                        <img
                          src="{% static 'assets/img/grad.png' %}"
                          class="avatar avatar-sm me-3"
                          alt="user1"
                        />
                      </div>
                      <div class="d-flex flex-column justify-content-center">
                        <h6 class="mb-0 text-sm">
                          <a href="{% url 'program_detail' pk=program.id%}" class="text-secondary"
                            >{{ program.name }}</a
                          >
                        </h6>
                        <p class="text-xs text-secondary mb-0">
                          {{program.code}}
                        </p>
                      </div>
                    </div>
                  </td>
                  <td>
                    <p class="text-xs font-weight-bold mb-0">
                      {{ program.department }}
                    </p>
                  </td>
                  <td>
                    {% if program.degree_level == 'M' %}
                    <p class="text-xs font-weight-bold mb-0">Masters</p>
                    {% elif program.degree_level == 'B'%}
                    <p class="text-xs font-weight-bold mb-0">Bachelors</p>
                    {% elif program.degree_level == 'PGd'%}
                    <p class="text-xs font-weight-bold mb-0">
                      Post Graduate Diploma
                    </p>
                    {% elif program.degree_level == 'D' %}
                    <p class="text-xs font-weight-bold mb-0">Diploma</p>
                    {% endif %}
                  </td>
                  <td class="align-middle">
                    <button
                      type="button"
                      class="btn btn-sm bg-gradient-dark"
                      data-bs-toggle="modal"
                      data-bs-target="#exampleModal"
                      @click="setProgramData(`{{program.id}}`, `{{program.name}}`, `{{program.code}}`, `{{program.years_of_study}}`,`{{program.get_degree_level_display}}`,`{{program.department_id}}`, `{{program.details}}`)"
                    >
                      <i class="fas fa-pen fa-2x"></i>
                    </button>
                  </td>
                  <td class="align-middle">
                    <a class="btn btn-sm bg-success" href="{% url 'program_detail' pk=program.id%}">
                      <i class="fas fa-eye fa-2x"></i>
                    </a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>

            {% comment %} A Program update and detail form {% endcomment %}

            <div
              class="modal fade"
              id="exampleModal"
              tabindex="-1"
              role="dialog"
              aria-labelledby="exampleModalLabel"
              aria-hidden="true"
            >
              <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">
                      Program Info
                    </h5>
                    <button
                      type="button"
                      class="btn-close text-dark"
                      data-bs-dismiss="modal"
                      aria-label="Close"
                    >
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                  <div class="modal-body">
                    <form method="post" action="" id="update-form">
                      {% csrf_token %}
                      <div id="div_id_name" class="form-group">
                        <label for="id_name" class="requiredField">
                          Name<span class="asteriskField">*</span>
                        </label>
                        <div>
                          <input
                            type="text"
                            name="name"
                            maxlength="255"
                            class="textinput form-control"
                            required
                            id="id_name"
                            :value="[[name]]"
                          />
                        </div>
                      </div>
                      <div id="div_id_code" class="form-group">
                        <label for="id_code" class="requiredField">
                          Code<span class="asteriskField">*</span>
                        </label>
                        <div>
                          <input
                            type="text"
                            name="code"
                            maxlength="10"
                            class="textinput form-control"
                            required
                            id="id_code"
                            :value="[[code]]"
                          />
                        </div>
                      </div>
                      <div id="div_id_years_of_study" class="form-group">
                        <label for="id_years_of_study" class="requiredField">
                          Years of study<span class="asteriskField">*</span>
                        </label>
                        <div>
                          <input
                            type="number"
                            name="years_of_study"
                            :value="[[years_of_study]]"
                            class="numberinput form-control"
                            required
                            id="id_years_of_study"
                          />
                        </div>
                      </div>
                      <div id="div_id_degree_level" class="form-group">
                        <label for="id_degree_level" class="requiredField">
                          Degree level<span class="asteriskField">*</span>
                        </label>
                        <div>
                          <select
                            name="degree_level"
                            class="select form-control"
                            required
                            id="id_degree_level"
                          >
                            <option value="[[degree_level]]" selected>
                              [[degree_level]]
                            </option>
                            <option value="D">Diploma</option>
                            <option value="B">Bachelors</option>
                            <option value="PGd">PostGraduateDiploma</option>
                            <option value="M">Masters</option>
                          </select>
                        </div>
                      </div>

                      <div id="div_id_details" class="form-group">
                        <label for="id_details" class="requiredField">
                          Details<span class="asteriskField">*</span>
                        </label>
                        <div>
                          <textarea
                            name="details"
                            cols="40"
                            rows="10"
                            class="textarea form-control"
                            required
                            id="id_details"
                          >
[[details]]</textarea
                          >
                        </div>
                      </div>
                      <div class="modal-footer">
                        <button
                          type="button"
                          class="btn bg-gradient-secondary"
                          data-bs-dismiss="modal"
                          @click="resetState"
                        >
                          Close
                        </button>
                        <button
                          type="button"
                          @click="updateProgram()"
                          class="btn bg-gradient-primary"
                        >
                          Update Program
                        </button>
                        <a
                          href="#"
                          class="btn bg-gradient-danger"
                          data-bs-toggle="modal"
                          data-bs-target="#deleteModal"
                          @click="deleteProgram()"
                          >Delete Program</a
                        >
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>

            {% comment %} Program Create form {% endcomment %}
            <div
              class="modal fade"
              id="ProgramCreateModal"
              tabindex="-1"
              role="dialog"
              aria-labelledby="exampleModalLabel"
              aria-hidden="true"
            >
              <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">
                      Create Program
                    </h5>
                    <button
                      type="button"
                      class="btn-close text-dark"
                      data-bs-dismiss="modal"
                      aria-label="Close"
                      @click="resetState()"
                    >
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                  <div class="modal-body">
                    <form method="post" action="" id="create-form">
                      {% csrf_token %} {{form|crispy}}
                      <div class="modal-footer">
                        <button
                          type="button"
                          @click="resetState()"
                          class="btn bg-gradient-dark"
                          data-bs-dismiss="modal"
                        >
                          Close
                        </button>
                        <button
                          type="button"
                          class="btn bg-gradient-primary"
                          @click="createProgram()"
                        >
                          Save
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>

            {% comment %} Modal for deleting Program {% endcomment %}
            <div
              class="modal fade"
              id="deleteModal"
              tabindex="-1"
              role="dialog"
              aria-labelledby="modal-notification"
              aria-hidden="true"
            >
              <div
                class="modal-dialog modal-danger modal-dialog-centered modal-"
                role="document"
              >
                <div class="modal-content">
                  <div class="modal-header">
                    <h6 class="modal-title" id="modal-title-notification">
                      Delete Program
                    </h6>
                    <button
                      type="button"
                      class="btn-close text-dark"
                      data-bs-dismiss="modal"
                      aria-label="Close"
                      @click="resetState()"
                    >
                      <span aria-hidden="true">×</span>
                    </button>
                  </div>
                  <div class="modal-body">
                    <div class="py-3 text-center">
                      <i class="ni ni-bell-55 ni-3x"></i>
                      <h4 class="text-gradient text-danger mt-4">
                        Are you sure you want to delete this Program?
                      </h4>
                      <p>[[name]]</p>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button
                      type="button"
                      class="btn bg-gradient-danger"
                      @click="deleteProgram()"
                    >
                      Ok, Delete
                    </button>
                    <button
                      type="button"
                      class="btn bg-gradient-dark text-white ml-auto"
                      data-bs-dismiss="modal"
                    >
                      Close
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% include "includes/footer.html" %}
</div>

{% endblock content %}

<!-- Specific JS goes HERE -->
{% block javascripts %}
<script>
  const app = Vue.createApp({
    mounted() {},
    data() {
      return {
        count: 0,
        id: "",
        name: "",
        code: "",
        years_of_study: "",
        degree_level: "",
      };
    },
    delimiters: ["[[", "]]"],
    methods: {
      setProgramData(
        id,
        name,
        code,
        years_of_study,
        degree_level,
        department_id,
        details
      ) {
        this.name = name;
        this.code = code;
        this.years_of_study = years_of_study;
        this.degree_level = degree_level;
        this.department_id = department_id;
        this.details = details;
        this.id = id;

        console.log({
          name,
          code,
          years_of_study,
          degree_level,
          department_id,
          details,
          id,
        });
      },
      resetState() {
        this.name = "";
        this.Program_head = "";
        this.contact_email = "";
        this.description = "";
      },
      async createProgram() {
        const createForm = document.getElementById("create-form");

        const tokenField = document.querySelector(
          'input[name="csrfmiddlewaretoken"]'
        );

        let csrfToken = tokenField.value;
        const formData = new FormData(createForm);

        let name = formData.get("name");
        let code = formData.get("code");
        let years_of_study = formData.get("years_of_study");
        let degree_level = formData.get("degree_level");
        let details = formData.get("details");
        let department_id = formData.get("department");

        const response = await fetch("/programs/create/", {
          method: "POST",
          headers: {
            "Content-Type": "Application/Json",
            "X-CSRFToken": csrfToken,
            "X-Requested-With": "XMLHttpRequest",
          },
          body: JSON.stringify({
            name,
            code,
            years_of_study,
            degree_level,
            details,
            department_id,
          }),
        });

        createForm.reset();

        window.location.reload();
      },
      async updateProgram() {
        const updateForm = document.getElementById("update-form");
        const tokenField = document.querySelector(
          'input[name="csrfmiddlewaretoken"]'
        );

        let csrfToken = tokenField.value;

        console.log(updateForm);

        const updateData = new FormData(updateForm);

        let body = {
          name: updateData.get("name"),
          code: updateData.get("code"),
          degree_level: updateData.get("degree_level"),
          years_of_study: updateData.get("years_of_study"),
          details: updateData.get("details"),
        };

        const response = await fetch(`/programs/update/${this.id}/`, {
          headers: {
            "Content-Type": "Application/Json",
            "X-CSRFToken": csrfToken,
            "X-Requested-With": "XMLHttpRequest",
          },
          method: "POST",
          body: JSON.stringify(body),
        });

        const data = await response.json();

        window.location.reload();
      },
      async deleteProgram() {
        const response = await fetch(`/programs/delete/${this.id}/`);

        const data = response.json();

        console.log(data);

        window.location.reload();
      },
    },
  }).mount("#app");
</script>
{% endblock javascripts %}
